# https://github.com/grafana/alloy/blob/main/operations/helm/charts/alloy/values.yaml

alloy:
  configMap:
    create: true
    content: |
      // Generated from configs/alloy.yaml
      logging {
        level = "info"
        format = "logfmt"
      }

      discovery.kubernetes "pods" {
        role = "pod"
      }

      discovery.relabel "pods" {
        targets = discovery.kubernetes.pods.targets

        rule {
          action = "labelmap"
          regex = "__meta_kubernetes_(namespace|(pod_(node_name|name|container_name|container_image)))"
        }
      }

      loki.source.kubernetes "pods" {
        targets    = discovery.relabel.pods.output
        forward_to = [loki.process.kubernetes_logs.receiver]
      }

      loki.process "kubernetes_logs" {
        stage.drop {
          older_than          = "30m"
          drop_counter_reason = "too old"
        }

        forward_to = [loki.write.default.receiver]
      }

      loki.write "default" {
        endpoint {
          url = env("LOKI_URL")
        }
        external_labels = {}
      }

  extraEnv:
    - name: LOKI_URL
      value: "http://loki-gateway.loki/loki/api/v1/push"

serviceMonitor:
  enabled: true
