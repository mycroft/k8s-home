apiVersion: v1
kind: Namespace
metadata:
  name: minio
---
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: secretstore-vault
  namespace: minio
spec:
  provider:
    vault:
      auth:
        kubernetes:
          mountPath: kubernetes
          role: external-secrets
      path: secret
      server: http://vault.vault:8200
      version: v2
---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: minio-es-storage-configuration-c818ca47
  namespace: minio
spec:
  dataFrom:
    - extract:
        conversionStrategy: Default
        key: secret/namespaces/minio/storage-configuration
  refreshInterval: 15m
  secretStoreRef:
    kind: SecretStore
    name: secretstore-vault
  target:
    creationPolicy: Owner
    deletionPolicy: Delete
    immutable: false
    name: storage-configuration
    template:
      engineVersion: v2
      type: Opaque
---
apiVersion: minio.min.io/v2
kind: Tenant
metadata:
  name: minio-storage
  namespace: minio
spec:
  configuration:
    name: storage-configuration
  env:
    - name: MINIO_DOMAIN
      value: minio-storage.services.mkz.me
    - name: MINIO_SERVER_URL
      value: https://minio-storage.services.mkz.me
    - name: MINIO_BROWSER_REDIRECT_URL
      value: https://minio-storage-console.services.mkz.me
  pools:
    - affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            - labelSelector:
                matchExpressions:
                  - key: v1.min.io/tenant
                    operator: In
                    values:
                      - minio-storage
              topologyKey: kubernetes.io/hostname
      containerSecurityContext:
        runAsGroup: 1000
        runAsNonRoot: true
        runAsUser: 1000
      name: pool
      servers: 2
      volumeClaimTemplate:
        metadata:
          name: data
        spec:
          accessModes:
            - ReadWriteOnce
          resources:
            requests:
              storage: 32Gi
          storageClassName: longhorn-crypto-global
      volumesPerServer: 2
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-prod
    traefik.ingress.kubernetes.io/redirect-entry-point: https
    traefik.ingress.kubernetes.io/redirect-permanent: "true"
  name: minio-minio-storage-ingress-c84ffb72
  namespace: minio
spec:
  ingressClassName: traefik
  rules:
    - host: minio-storage.services.mkz.me
      http:
        paths:
          - backend:
              service:
                name: minio
                port:
                  number: 443
            path: /
            pathType: Prefix
    - host: minio-storage-console.services.mkz.me
      http:
        paths:
          - backend:
              service:
                name: minio-storage-console
                port:
                  number: 9443
            path: /
            pathType: Prefix
  tls:
    - hosts:
        - minio-storage.services.mkz.me
        - minio-storage-console.services.mkz.me
      secretName: secret-tls-www
