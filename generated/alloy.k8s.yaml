apiVersion: v1
kind: Namespace
metadata:
  name: alloy
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: alloy-helm-val-alloy-c88c2f34
  namespace: alloy
data:
  values.yaml: |
    # https://github.com/grafana/alloy/blob/main/operations/helm/charts/alloy/values.yaml

    alloy:
      configMap:
        create: true
        content: |
          // Generated from configs/alloy.yaml
          logging {
            level = "info"
            format = "logfmt"
          }

          discovery.kubernetes "pods" {
            role = "pod"
            namespaces = ["default", "emojivoto"]
          }

          discovery.relabel "pods" {
            targets = discovery.kubernetes.pods.targets

            rule {
              action = "labelmap"
              regex = "__meta_kubernetes_(namespace|(pod_(node_name|name|container_name|container_image)))"
            }
          }

          loki.source.kubernetes "pods" {
            targets    = discovery.relabel.pods.targets
            forward_to = [loki.process.kubernetes_logs.receiver]
          }

          loki.process "kubernetes_logs" {
            stage.drop {
              older_than          = "30m"
              drop_counter_reason = "too old"
            }

            forward_to = [loki.write.default.receiver]
          }

          loki.write "default" {
            endpoint {
              url = env("LOKI_URL")
            }
            external_labels = {}
          }

      extraEnv:
        - name: LOKI_URL
          value: "http://loki-gateway.loki/loki/api/v1/push"

    serviceMonitor:
      enabled: true
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  annotations:
    configMapHash: a787e6d6850f6b3e34e6c37f2476a1fe94cbb4e1d8afe34561603a689bf45a23
  name: alloy
  namespace: alloy
spec:
  chart:
    spec:
      chart: alloy
      sourceRef:
        kind: HelmRepository
        name: grafana
        namespace: flux-system
      version: 0.3.2
  install:
    createNamespace: false
    skipCRDs: false
  interval: 10m0s
  timeout: 5m0s
  values: {}
  valuesFrom:
    - kind: ConfigMap
      name: alloy-helm-val-alloy-c88c2f34
      valuesKey: values.yaml
