apiVersion: v1
kind: Namespace
metadata:
  name: alloy
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: alloy-helm-val-alloy-c88c2f34
  namespace: alloy
data:
  values.yaml: |
    # https://github.com/grafana/alloy/blob/main/operations/helm/charts/alloy/values.yaml

    alloy:
      configMap:
        create: true
        content: |
          // Generated from configs/alloy.yaml
          logging {
            level = "info"
            format = "logfmt"
          }

          discovery.kubernetes "pods" {
            role = "pod"
          }

          loki.source.kubernetes "pods" {
            targets    = discovery.kubernetes.pods.targets
            forward_to = [loki.write.default.receiver]
          }

          loki.write "default" {
            endpoint {
              url = env("LOKI_URL")
            }
            external_labels = {}
          }

          loki.echo "echo" {}

      extraEnv:
        - name: LOKI_URL
          value: "http://loki-gateway.loki/loki/api/v1/push"

    serviceMonitor:
      enabled: true
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  annotations:
    configMapHash: d9fbca54b6d157f25f2d0e659da5c18707d5633853ed5de16fa3700d1fb18ec7
  name: alloy
  namespace: alloy
spec:
  chart:
    spec:
      chart: alloy
      sourceRef:
        kind: HelmRepository
        name: grafana
        namespace: flux-system
      version: 0.3.2
  install:
    createNamespace: false
    skipCRDs: false
  interval: 10m0s
  timeout: 5m0s
  values: {}
  valuesFrom:
    - kind: ConfigMap
      name: alloy-helm-val-alloy-c88c2f34
      valuesKey: values.yaml
