apiVersion: v1
kind: Namespace
metadata:
  name: alloy
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: alloy-helm-val-alloy-c88c2f34
  namespace: alloy
data:
  values.yaml: |
    # https://github.com/grafana/alloy/blob/main/operations/helm/charts/alloy/values.yaml

    alloy:
      configMap:
        create: true
        content: |
          discovery.kubernetes "pods" {
            role = "pod"
          }

          loki.source.kubernetes "pods" {
            targets    = discovery.kubernetes.pods.targets
            forward_to = [loki.write.cluster.receiver]
            labels     = { "source" = "alloy-pods" }
          }

          loki.write "cluster" {
            endpoint {
              url = env("LOKI_URL")
            }
            external_labels = {}
          }

          loki.echo "echo" {}

      extraEnv:
        - name: LOKI_URL
          value: "http://loki-gateway.loki/loki/api/v1/push"

    serviceMonitor:
      enabled: true
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  annotations:
    configMapHash: 2a80e9801673a1f526fee862a2595171386b512436104c9d0539d921736ca76f
  name: alloy
  namespace: alloy
spec:
  chart:
    spec:
      chart: alloy
      sourceRef:
        kind: HelmRepository
        name: grafana
        namespace: flux-system
      version: 0.3.2
  install:
    createNamespace: false
    skipCRDs: false
  interval: 10m0s
  timeout: 5m0s
  values: {}
  valuesFrom:
    - kind: ConfigMap
      name: alloy-helm-val-alloy-c88c2f34
      valuesKey: values.yaml
